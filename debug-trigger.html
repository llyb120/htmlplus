<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Trigger 监控</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .log {
            background: #2d2d2d;
            padding: 5px 10px;
            margin: 2px 0;
            border-left: 3px solid #007acc;
            font-size: 11px;
        }
        .track { border-left-color: #2196f3; }
        .trigger { border-left-color: #f44336; font-weight: bold; }
        .render { border-left-color: #4caf50; font-weight: bold; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>🔍 Trigger 监控</h1>
    <div id="display"></div>
    <div id="logs" style="max-height: 600px; overflow-y: auto; margin-top: 20px;"></div>

    <script>
        const logs = [];
        function addLog(message, type = 'log') {
            logs.push({ message, type });
            updateLogs();
        }
        
        function updateLogs() {
            document.getElementById('logs').innerHTML = logs.map(l => 
                `<div class="log ${l.type}">${l.message}</div>`
            ).join('');
            const logsDiv = document.getElementById('logs');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // 在加载框架之前，准备拦截
        addLog('准备加载框架...', 'log');
    </script>
    
    <script src="reactive-lit.js"></script>
    
    <script>
        const { html, createComponent, useState } = window.ReactiveLit;
        addLog('✅ 框架加载完成', 'log');

        // 拦截 window 上的 track 和 trigger（如果导出的话）
        // 由于它们在闭包中，我们需要修改框架代码来导出它们
        // 暂时先测试基本功能
        
        let renderCount = 0;

        createComponent('test-comp', () => {
            renderCount++;
            addLog(`━━━━ 🎬 渲染 #${renderCount} ━━━━`, 'render');
            
            const arr = useState([1, 2, 3]);
            addLog(`  读取 arr: [${arr()}]`, 'log');
            
            const obj = useState({ a: 1, b: 2 });
            addLog(`  读取 obj: ${JSON.stringify(obj())}`, 'log');

            const result = html`
                <div style="background: #2d2d2d; padding: 20px;">
                    <h2>渲染次数: ${renderCount}</h2>
                    <h3>arr = [${arr().join(', ')}]</h3>
                    <h3>obj.a = ${obj().a}, obj.b = ${obj().b}</h3>
                    
                    <button onClick=${() => {
                        addLog('━━━━━━━━━━━━━━━━━━━━━━', 'trigger');
                        addLog('🔴 执行: arr().push(999)', 'trigger');
                        
                        const arrValue = arr();
                        addLog(`  获取到的 arr: [${arrValue}]`, 'log');
                        addLog(`  arr 是否为响应式: ${arrValue.__isReactive}`, 'log');
                        addLog(`  调用 push 方法...`, 'log');
                        
                        arrValue.push(999);
                        
                        addLog(`  push 后的 arr: [${arrValue}]`, 'log');
                        addLog('  等待 DOM 更新...', 'log');
                    }}>
                        📝 arr().push(999)
                    </button>
                    
                    <button onClick=${() => {
                        addLog('━━━━━━━━━━━━━━━━━━━━━━', 'trigger');
                        addLog('🔵 执行: obj().a++', 'trigger');
                        
                        const objValue = obj();
                        addLog(`  获取到的 obj: ${JSON.stringify(objValue)}`, 'log');
                        addLog(`  obj 是否为响应式: ${objValue.__isReactive}`, 'log');
                        addLog(`  修改 a 属性...`, 'log');
                        
                        objValue.a++;
                        
                        addLog(`  修改后的 obj: ${JSON.stringify(objValue)}`, 'log');
                        addLog('  等待 DOM 更新...', 'log');
                    }}>
                        ➕ obj().a++
                    </button>
                    
                    <button onClick=${() => {
                        addLog('━━━━━━━━━━━━━━━━━━━━━━', 'trigger');
                        addLog('🟢 执行: arr([...arr(), 888])', 'trigger');
                        arr([...arr(), 888]);
                        addLog('  重新赋值完成', 'log');
                    }}>
                        🔄 重新赋值
                    </button>
                </div>
            `;
            
            return result;
        });

        document.getElementById('display').innerHTML = '<test-comp></test-comp>';
        
        setTimeout(() => {
            addLog('━━━━━━━━━━━━━━━━━━━━━━', 'log');
            addLog('🎉 初始化完成！点击按钮测试', 'log');
        }, 100);
    </script>
</body>
</html>

