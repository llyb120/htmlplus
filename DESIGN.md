# ğŸ¯ å“åº”å¼æ¡†æ¶è®¾è®¡æ–¹æ¡ˆ

## å½“å‰é—®é¢˜

### ç°çŠ¶
1. âœ… Setup åªæ‰§è¡Œä¸€æ¬¡
2. âŒ æ¸²æŸ“å‡½æ•°æ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½æ‰§è¡Œ
3. âœ… æ¨¡æ¿ç³»ç»Ÿæ”¯æŒç»†ç²’åº¦æ›´æ–°

### æœŸæœ›
- æ¸²æŸ“å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡
- çŠ¶æ€å˜åŒ–æ—¶ï¼Œåªæ›´æ–°æ¨¡æ¿ä¸­å˜åŒ–çš„éƒ¨åˆ†
- ä¸éœ€è¦åƒ React é‚£æ ·æ¯æ¬¡ diff

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå½“å‰å®ç°ï¼ˆç®€å•ä½†ä¸å¤Ÿé«˜æ•ˆï¼‰

```javascript
createComponent('my-counter', () => {
  const count = useState(0);
  
  return () => html`<div>${count()}</div>`;
  //     â†‘ æ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½æ‰§è¡Œ
});
```

**æµç¨‹ï¼š**
1. Setup æ‰§è¡Œä¸€æ¬¡
2. è¿”å›æ¸²æŸ“å‡½æ•°
3. æ¸²æŸ“å‡½æ•°åŒ…åœ¨ effect ä¸­
4. çŠ¶æ€å˜åŒ– â†’ effect é‡æ–°æ‰§è¡Œ â†’ æ¸²æŸ“å‡½æ•°æ‰§è¡Œ â†’ ç”Ÿæˆæ–° TemplateResult
5. `render()` è°ƒç”¨ `TemplateInstance.update(newValues)`
6. åªæ›´æ–°å˜åŒ–çš„ parts

**ä¼˜ç‚¹ï¼š**
- å®ç°ç®€å•
- å…¼å®¹æ€§å¥½
- ç”¨æˆ·APIç®€å•

**ç¼ºç‚¹ï¼š**
- æ¸²æŸ“å‡½æ•°æ¯æ¬¡éƒ½æ‰§è¡Œï¼ˆè®¡ç®—æ–°çš„ valuesï¼‰

### æ–¹æ¡ˆ Bï¼šç»†ç²’åº¦å“åº”å¼ï¼ˆå¤æ‚ä½†æœ€ä¼˜ï¼‰

```javascript
createComponent('my-counter', () => {
  const count = useState(0);
  
  return () => html`<div>${() => count()}</div>`;
  //                        â†‘ ä¼ å…¥ getter å‡½æ•°
});
```

**æµç¨‹ï¼š**
1. Setup æ‰§è¡Œä¸€æ¬¡
2. æ¸²æŸ“å‡½æ•°æ‰§è¡Œä¸€æ¬¡ï¼Œç”Ÿæˆ TemplateResultï¼ˆvalues åŒ…å« getter å‡½æ•°ï¼‰
3. ä¸ºæ¯ä¸ª TemplatePart åˆ›å»ºç‹¬ç«‹çš„ effect
4. çŠ¶æ€å˜åŒ– â†’ åªé‡æ–°æ±‚å€¼å¯¹åº”çš„ getter â†’ åªæ›´æ–°å¯¹åº”çš„ part

**ä¼˜ç‚¹ï¼š**
- æœ€ç»†ç²’åº¦çš„æ›´æ–°
- æ¸²æŸ“å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡
- æ€§èƒ½æœ€ä¼˜

**ç¼ºç‚¹ï¼š**
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨åŒ…è£… `() => count()`
- å®ç°å¤æ‚
- éœ€è¦åŒºåˆ† getter å’Œäº‹ä»¶å¤„ç†å™¨

### æ–¹æ¡ˆ Cï¼šç¼–è¯‘æ—¶ä¼˜åŒ–ï¼ˆéœ€è¦æ„å»ºå·¥å…·ï¼‰

ä½¿ç”¨ Babel/SWC æ’ä»¶è‡ªåŠ¨è½¬æ¢ï¼š

```javascript
// ç”¨æˆ·å†™
html`<div>${count()}</div>`

// ç¼–è¯‘å
html`<div>${() => count()}</div>`
```

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ¸²æŸ“å‡½æ•°æ‰§è¡Œ | ç”¨æˆ·API | å®ç°éš¾åº¦ | æ€§èƒ½ |
|------|------------|---------|---------|------|
| A - å½“å‰ | æ¯æ¬¡ | ç®€å• | ç®€å• | è‰¯å¥½ |
| B - ç»†ç²’åº¦ | ä¸€æ¬¡ | å¤æ‚ | å¤æ‚ | æœ€ä¼˜ |
| C - ç¼–è¯‘ | ä¸€æ¬¡ | ç®€å• | æœ€å¤æ‚ | æœ€ä¼˜ |

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### çŸ­æœŸï¼šä¿æŒæ–¹æ¡ˆ A
- å®ç°ç®€å•ï¼Œç”¨æˆ·APIå‹å¥½
- æ€§èƒ½å·²ç»å¾ˆå¥½ï¼ˆæ¨¡æ¿ç³»ç»Ÿåšäº†ç»†ç²’åº¦æ›´æ–°ï¼‰
- æ¸²æŸ“å‡½æ•°æ‰§è¡Œå¼€é”€ä¸å¤§ï¼ˆåªæ˜¯è®¡ç®—valuesï¼‰

### é•¿æœŸï¼šå®ç°æ–¹æ¡ˆ B + ä¿æŒæ–¹æ¡ˆ A å…¼å®¹

æä¾›ä¸¤ç§APIï¼š

```javascript
// ç®€å•æ¨¡å¼ï¼ˆè‡ªåŠ¨å“åº”å¼ï¼‰
createComponent('simple', () => {
  const count = useState(0);
  return () => html`<div>${count()}</div>`;
});

// é«˜æ€§èƒ½æ¨¡å¼ï¼ˆæ‰‹åŠ¨ä¼˜åŒ–ï¼‰
createComponent('optimized', () => {
  const count = useState(0);
  return html`<div>${() => count()}</div>`;
  //     â†‘ ç›´æ¥è¿”å›æ¨¡æ¿ï¼Œä¸è¿”å›å‡½æ•°
  //          values ä¸­çš„ getter ä¼šè¢«è‡ªåŠ¨åŒ…è£… effect
});
```

## ğŸš€ å®ç°ç»†èŠ‚ï¼ˆæ–¹æ¡ˆ Bï¼‰

### 1. TemplatePart å¢åŠ  effect æ”¯æŒ

```javascript
class TemplatePart {
  setValue(value) {
    // å¦‚æœæ˜¯å‡½æ•°ä¸”ä¸æ˜¯äº‹ä»¶å¤„ç†å™¨
    if (typeof value === 'function' && this.name === 'node') {
      // åŒ…è£…åœ¨ effect ä¸­
      if (!this._effect) {
        this._effect = effect(() => {
          const result = value(); // è°ƒç”¨ getter
          this.commit(result);
        });
      }
      return;
    }
    
    // æ­£å¸¸æµç¨‹
    if (this.value !== value) {
      this.value = value;
      this.commit();
    }
  }
}
```

### 2. åŒºåˆ† getter å’Œäº‹ä»¶å¤„ç†å™¨

```javascript
function isGetter(fn) {
  // getter: ç®­å¤´å‡½æ•°ï¼Œæ— å‚æ•°ï¼Œè¿”å›å€¼
  // handler: é€šå¸¸æœ‰å‚æ•°(event)
  const str = fn.toString();
  return /^\(\)\s*=>/.test(str) || /^function\s*\(\)\s*\{/.test(str);
}
```

### 3. ç”¨æˆ·API

```javascript
html`
  <div>
    ${() => count()}           <!-- getter: è‡ªåŠ¨å“åº”å¼ -->
    <button onClick=${handleClick}>  <!-- handler: äº‹ä»¶ -->
  `
```

## ğŸ“ æ€»ç»“

å½“å‰å®ç°å·²ç»è¶³å¤Ÿå¥½ï¼Œæ¸²æŸ“å‡½æ•°é‡æ–°æ‰§è¡Œçš„å¼€é”€å¾ˆå°ã€‚å¦‚æœæœªæ¥éœ€è¦æè‡´æ€§èƒ½ï¼Œå¯ä»¥å®ç°æ–¹æ¡ˆBä½œä¸ºå¯é€‰ä¼˜åŒ–ã€‚

