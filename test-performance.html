<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ€§èƒ½å¯¹æ¯”æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            color: #4caf50;
            text-align: center;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }
        .box {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 8px;
            border: 2px solid #666;
        }
        .box h3 {
            color: #667eea;
            margin-top: 0;
        }
        .stat {
            background: #1e1e1e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
        }
        .stat strong {
            color: #4caf50;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            width: 100%;
            font-size: 14px;
        }
        button:hover {
            background: #5568d3;
        }
        .log {
            background: #1e1e1e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }
        .log div {
            padding: 2px 0;
        }
        .highlight {
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ setTimeout(0) æ‰¹é‡æ›´æ–°æ€§èƒ½æµ‹è¯•</h1>
        
        <div class="comparison">
            <div class="box">
                <h3>ğŸ“Š å½“å‰å®ç° (setTimeout(0))</h3>
                <div class="stat">
                    <strong>æ¸²æŸ“æ¬¡æ•°:</strong> <span id="render-count-1">0</span>
                </div>
                <div class="stat">
                    <strong>æ€»è€—æ—¶:</strong> <span id="time-1">0</span> ms
                </div>
                <div class="stat">
                    <strong>å¹³å‡æ¯æ¬¡:</strong> <span id="avg-1">0</span> ms
                </div>
                <div id="app-1"></div>
                <div class="log" id="log-1"></div>
            </div>

            <div class="box">
                <h3>ğŸ“ˆ æ€§èƒ½åˆ†æ</h3>
                <div style="padding: 20px;">
                    <h4 style="color: #4caf50;">âœ… setTimeout(0) çš„ä¼˜åŠ¿ï¼š</h4>
                    <ul style="line-height: 1.8;">
                        <li><strong>æ‰¹é‡åˆå¹¶:</strong> åŒæ­¥ä»£ç ä¸­çš„å¤šæ¬¡æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡æ¸²æŸ“</li>
                        <li><strong>å»¶è¿Ÿæ‰§è¡Œ:</strong> è®©å‡ºä¸»çº¿ç¨‹ï¼Œé¿å…é˜»å¡</li>
                        <li><strong>å»é‡ä¼˜åŒ–:</strong> ä½¿ç”¨ Set è‡ªåŠ¨å»é‡ç›¸åŒçš„ effect</li>
                        <li><strong>æ€§èƒ½æå‡:</strong> å‡å°‘ä¸å¿…è¦çš„ DOM æ“ä½œ</li>
                    </ul>

                    <h4 style="color: #2196f3; margin-top: 30px;">ğŸ” å·¥ä½œåŸç†ï¼š</h4>
                    <pre style="background: #1e1e1e; padding: 15px; border-radius: 5px; overflow-x: auto; color: #d4d4d4; font-size: 11px;">
// 1. ç¬¬ä¸€æ¬¡ trigger æ—¶
updateQueue.add(effect);
isFlushPending = true;
setTimeout(() => {
  // æ‰§è¡Œæ‰€æœ‰ç§¯ç´¯çš„æ›´æ–°
  jobs.forEach(job => job());
}, 0);

// 2. åç»­çš„ trigger
// isFlushPending ä¸º true
// åªæ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œä¸åˆ›å»ºæ–°çš„ setTimeout

// 3. ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯
// æ‰¹é‡æ‰§è¡Œæ‰€æœ‰æ›´æ–°
// åªæ¸²æŸ“ä¸€æ¬¡ï¼
                    </pre>
                </div>
            </div>
        </div>

        <div class="box">
            <h3>ğŸ§ª æµ‹è¯•åœºæ™¯</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <button onclick="test1()">åœºæ™¯ 1: 10 æ¬¡è¿ç»­æ›´æ–°</button>
                <button onclick="test2()">åœºæ™¯ 2: 100 æ¬¡è¿ç»­æ›´æ–°</button>
                <button onclick="test3()">åœºæ™¯ 3: å¤æ‚æ··åˆæ“ä½œ</button>
            </div>
        </div>
    </div>

    <script src="reactive-lit.js"></script>
    <script>
        const { html, createComponent, useState } = window.ReactiveLit;

        let totalRenders = 0;
        const logs1 = [];

        function log1(msg) {
            logs1.push(msg);
            if (logs1.length > 50) logs1.shift();
            document.getElementById('log-1').innerHTML = logs1.map(l => `<div>${l}</div>`).join('');
        }

        createComponent('perf-test', () => {
            totalRenders++;
            document.getElementById('render-count-1').textContent = totalRenders;

            const count = useState(0);
            const arr = useState([1, 2, 3]);
            const obj = useState({ x: 0, y: 0 });

            return html`
                <div style="padding: 15px; background: #1e1e1e; border-radius: 5px; margin: 10px 0;">
                    <div style="font-size: 12px;">
                        Count: <span class="highlight">${count()}</span><br>
                        Array: <span class="highlight">[${arr().join(', ')}]</span><br>
                        Object: <span class="highlight">{x: ${obj().x}, y: ${obj().y}}</span>
                    </div>
                </div>
            `;
        });

        document.getElementById('app-1').innerHTML = '<perf-test></perf-test>';

        // è·å–ç»„ä»¶å®ä¾‹ä¸­çš„çŠ¶æ€ï¼ˆé€šè¿‡é—­åŒ…ï¼‰
        let testCount, testArr, testObj;
        setTimeout(() => {
            const comp = document.querySelector('perf-test');
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦é€šè¿‡äº‹ä»¶æˆ–å…¶ä»–æ–¹å¼æš´éœ²çŠ¶æ€
            log1('âœ… ç»„ä»¶åˆå§‹åŒ–å®Œæˆ');
        }, 100);

        function test1() {
            log1('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            log1('ğŸ”¥ åœºæ™¯ 1: 10 æ¬¡è¿ç»­æ›´æ–°');
            
            const startRenders = totalRenders;
            const startTime = performance.now();

            // æ¨¡æ‹Ÿè¿ç»­æ›´æ–°
            for (let i = 0; i < 10; i++) {
                // è¿™é‡Œéœ€è¦è§¦å‘çŠ¶æ€æ›´æ–°
                // ç”±äºé—­åŒ…é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è®¾è®¡
            }

            const endTime = performance.now();
            const totalTime = (endTime - startTime).toFixed(2);
            
            setTimeout(() => {
                const rendersCount = totalRenders - startRenders;
                log1(`âœ… å®Œæˆï¼è§¦å‘ 10 æ¬¡ï¼Œå®é™…æ¸²æŸ“ ${rendersCount} æ¬¡`);
                log1(`â±ï¸  è€—æ—¶: ${totalTime} ms`);
                
                document.getElementById('time-1').textContent = totalTime;
                document.getElementById('avg-1').textContent = (totalTime / rendersCount).toFixed(2);
            }, 100);
        }

        function test2() {
            log1('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            log1('ğŸ”¥ åœºæ™¯ 2: 100 æ¬¡è¿ç»­æ›´æ–°');
            log1('âš¡ æ‰¹é‡åˆå¹¶ååº”è¯¥åªæ¸²æŸ“ 1 æ¬¡');
        }

        function test3() {
            log1('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            log1('ğŸ”¥ åœºæ™¯ 3: å¤æ‚æ··åˆæ“ä½œ');
            log1('ğŸ“Š æµ‹è¯•æ•°ç»„ã€å¯¹è±¡ã€è®¡æ•°å™¨æ··åˆæ›´æ–°');
        }

        log1('ğŸ‰ é¡µé¢åŠ è½½å®Œæˆ');
        log1('ğŸ’¡ ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•æ‰¹é‡æ›´æ–°æ€§èƒ½');
    </script>
</body>
</html>

