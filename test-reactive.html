<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>响应式系统测试</title>
    <script src="reactive-lit.js" ></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-case {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .test-case h3 {
            margin-top: 0;
            color: #667eea;
        }
        
        .result {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        .pass {
            color: green;
            font-weight: bold;
        }
        
        .fail {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🧪 响应式系统测试</h1>

    <div class="test-case">
        <h3>测试 1: 基础响应式更新</h3>
        <p>点击按钮，计数器应该立即更新</p>
        <div id="test1"></div>
        <div class="result" id="test1-result"></div>
    </div>

    <div class="test-case">
        <h3>测试 2: 批量更新（连续多次修改）</h3>
        <p>点击按钮会连续修改 5 次，应该只渲染一次</p>
        <div id="test2"></div>
        <div class="result" id="test2-result"></div>
    </div>

    <div class="test-case">
        <h3>测试 3: 多个状态依赖</h3>
        <p>修改任何一个状态都应该触发更新</p>
        <div id="test3"></div>
        <div class="result" id="test3-result"></div>
    </div>

    <div class="test-case">
        <h3>测试 4: 嵌套组件</h3>
        <p>父组件和子组件都应该正常工作</p>
        <div id="test4"></div>
        <div class="result" id="test4-result"></div>
    </div>

    <div class="test-case">
        <h3>测试 5: Reactive 对象</h3>
        <p>使用 reactive() 创建的对象应该能触发更新</p>
        <div id="test5"></div>
        <div class="result" id="test5-result"></div>
    </div>

    <script>
        // const { html, render, reactive, createComponent, createState } = window.ReactiveLit;

        // 测试 1: 基础响应式更新
        (() => {
            const container = document.getElementById('test1');
            let renderCount = 0;
            
            createComponent(() => {
                renderCount++;
                const [count, setCount] = createState(0);
                
                const template = html`
                    <div>
                        <p>计数: ${count()}</p>
                        <button onClick=${() => setCount(count() + 1)}>增加</button>
                        <p style="color: #999;">渲染次数: ${renderCount}</p>
                    </div>
                `;
                
                render(template, container);
                
                document.getElementById('test1-result').innerHTML = 
                    `初始渲染完成。点击按钮测试响应式更新。`;
            }, container);
        })();

        // 测试 2: 批量更新
        (() => {
            const container = document.getElementById('test2');
            let renderCount = 0;
            
            createComponent(() => {
                renderCount++;
                const [count, setCount] = createState(0);
                
                const batchUpdate = () => {
                    const startCount = renderCount;
                    // 连续修改 5 次
                    setCount(count() + 1);
                    setCount(count() + 1);
                    setCount(count() + 1);
                    setCount(count() + 1);
                    setCount(count() + 1);
                    
                    // 等待批量更新完成
                    setTimeout(() => {
                        const endCount = renderCount;
                        const updates = endCount - startCount;
                        document.getElementById('test2-result').innerHTML = 
                            updates === 1 
                            ? `<span class="pass">✅ 通过：5次修改只触发了1次渲染</span>`
                            : `<span class="fail">❌ 失败：5次修改触发了${updates}次渲染</span>`;
                    }, 100);
                };
                
                const template = html`
                    <div>
                        <p>计数: ${count()}</p>
                        <button onClick=${batchUpdate}>批量修改5次</button>
                        <p style="color: #999;">渲染次数: ${renderCount}</p>
                    </div>
                `;
                
                render(template, container);
            }, container);
        })();

        // 测试 3: 多个状态依赖
        (() => {
            const container = document.getElementById('test3');
            let renderCount = 0;
            
            createComponent(() => {
                renderCount++;
                const [firstName, setFirstName] = createState('张');
                const [lastName, setLastName] = createState('三');
                
                const template = html`
                    <div>
                        <p>姓名: ${firstName()}${lastName()}</p>
                        <button onClick=${() => setFirstName('李')}>改姓</button>
                        <button onClick=${() => setLastName('四')}>改名</button>
                        <p style="color: #999;">渲染次数: ${renderCount}</p>
                    </div>
                `;
                
                render(template, container);
                
                document.getElementById('test3-result').innerHTML = 
                    `点击任一按钮，姓名都应该更新。`;
            }, container);
        })();

        // 测试 4: 嵌套组件
        (() => {
            const parentContainer = document.getElementById('test4');
            let parentRenderCount = 0;
            let childRenderCount = 0;
            
            // 父组件
            createComponent(() => {
                parentRenderCount++;
                const [parentCount, setParentCount] = createState(0);
                
                const template = html`
                    <div style="padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <h4>父组件</h4>
                        <p>父计数: ${parentCount()}</p>
                        <button onClick=${() => setParentCount(parentCount() + 1)}>父+1</button>
                        <p style="color: #999;">父渲染次数: ${parentRenderCount}</p>
                        
                        <div id="child-container" style="margin-top: 15px;"></div>
                    </div>
                `;
                
                render(template, parentContainer);
                
                // 子组件
                const childContainer = document.getElementById('child-container');
                if (childContainer && childRenderCount === 0) {
                    createComponent(() => {
                        childRenderCount++;
                        const [childCount, setChildCount] = createState(0);
                        
                        const childTemplate = html`
                            <div style="padding: 15px; background: #fff3e0; border-radius: 5px;">
                                <h4>子组件</h4>
                                <p>子计数: ${childCount()}</p>
                                <button onClick=${() => setChildCount(childCount() + 1)}>子+1</button>
                                <p style="color: #999;">子渲染次数: ${childRenderCount}</p>
                            </div>
                        `;
                        
                        render(childTemplate, childContainer);
                    }, childContainer);
                }
                
                document.getElementById('test4-result').innerHTML = 
                    `父组件和子组件应该独立工作，互不影响。`;
            }, parentContainer);
        })();

        // 测试 5: Reactive 对象
        (() => {
            const container = document.getElementById('test5');
            let renderCount = 0;
            
            createComponent(() => {
                renderCount++;
                const state = reactive({
                    user: {
                        name: '张三',
                        age: 25
                    },
                    count: 0
                });
                
                const template = html`
                    <div>
                        <p>姓名: ${state.user.name}, 年龄: ${state.user.age}</p>
                        <p>计数: ${state.count}</p>
                        <button onClick=${() => state.user.name = '李四'}>改名</button>
                        <button onClick=${() => state.user.age++}>年龄+1</button>
                        <button onClick=${() => state.count++}>计数+1</button>
                        <p style="color: #999;">渲染次数: ${renderCount}</p>
                    </div>
                `;
                
                render(template, container);
                
                document.getElementById('test5-result').innerHTML = 
                    `修改 reactive 对象的任何属性都应该触发更新。`;
            }, container);
        })();
    </script>
</body>
</html>

