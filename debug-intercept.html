<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>拦截调试</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-size: 12px;
        }
        .log {
            background: #2d2d2d;
            padding: 3px 8px;
            margin: 1px 0;
            border-left: 3px solid #666;
        }
        .track { border-left-color: #2196f3; }
        .trigger { border-left-color: #f44336; }
        .render { border-left-color: #4caf50; font-size: 13px; font-weight: bold; }
        .action { border-left-color: #ff9800; font-weight: bold; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        #display {
            background: #2d2d2d;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #4caf50;
        }
    </style>
</head>
<body>
    <h1>🔍 拦截调试</h1>
    <div id="display"></div>
    <div id="logs" style="max-height: 500px; overflow-y: auto;"></div>

    <script src="reactive-lit.js"></script>
    
    <script>
        const logs = [];
        function addLog(msg, type = 'log') {
            logs.push({ msg, type });
            const el = document.getElementById('logs');
            el.innerHTML = logs.map(l => `<div class="log ${l.type}">${l.msg}</div>`).join('');
            el.scrollTop = el.scrollHeight;
        }

        const { html, createComponent, useState } = window.ReactiveLit;
        const debug = window.__reactive_debug__;
        
        addLog('✅ 框架加载完成', 'log');
        addLog(`调试对象: ${Object.keys(debug).join(', ')}`, 'log');

        // 拦截 track 和 trigger
        const originalTrack = debug.track;
        const originalTrigger = debug.trigger;
        
        debug.track = function(target, key) {
            const targetDesc = Array.isArray(target) ? 'Array' : (target.constructor?.name || 'Object');
            addLog(`  📘 track(${targetDesc}, "${key}")`, 'track');
            return originalTrack.call(this, target, key);
        };
        
        debug.trigger = function(target, key) {
            const targetDesc = Array.isArray(target) ? 'Array' : (target.constructor?.name || 'Object');
            addLog(`  🔔 trigger(${targetDesc}, "${key}")`, 'trigger');
            return originalTrigger.call(this, target, key);
        };

        let renderCount = 0;

        createComponent('test-comp', () => {
            renderCount++;
            addLog(`━━━━ 🎬 渲染 #${renderCount} ━━━━`, 'render');
            
            const arr = useState([1, 2, 3]);
            addLog(`创建 arr state`, 'log');
            
            const obj = useState({ a: 1, b: 2 });
            addLog(`创建 obj state`, 'log');
            
            addLog(`开始构建模板...`, 'log');

            const result = html`
                <div>
                    <h2>渲染 #${renderCount}</h2>
                    <h3>arr = [${arr().join(', ')}]</h3>
                    <h3>obj = ${JSON.stringify(obj())}</h3>
                    
                    <button onClick=${() => {
                        addLog('━━━━━━━━━━━━━━━━━━━━━━', 'action');
                        addLog('🔴 点击: arr().push(999)', 'action');
                        
                        const a = arr();
                        addLog(`  arr() 返回: ${a}, 响应式=${a.__isReactive}`, 'log');
                        addLog(`  调用 push...`, 'log');
                        
                        a.push(999);
                        
                        addLog(`  push 完成`, 'log');
                        addLog(`  当前 arr: [${a}]`, 'log');
                    }}>arr().push(999)</button>
                    
                    <button onClick=${() => {
                        addLog('━━━━━━━━━━━━━━━━━━━━━━', 'action');
                        addLog('🔵 点击: obj().a++', 'action');
                        
                        const o = obj();
                        addLog(`  obj() 返回: ${JSON.stringify(o)}, 响应式=${o.__isReactive}`, 'log');
                        addLog(`  执行 a++...`, 'log');
                        
                        o.a++;
                        
                        addLog(`  a++ 完成`, 'log');
                        addLog(`  当前 obj: ${JSON.stringify(o)}`, 'log');
                    }}>obj().a++</button>
                    
                    <button onClick=${() => {
                        addLog('━━━━━━━━━━━━━━━━━━━━━━', 'action');
                        addLog('🟢 点击: arr([...arr(), 888])', 'action');
                        arr([...arr(), 888]);
                        addLog('  重新赋值完成', 'log');
                    }}>重新赋值</button>
                </div>
            `;
            
            return result;
        });

        document.getElementById('display').innerHTML = '<test-comp></test-comp>';
        
        setTimeout(() => {
            addLog('━━━━━━━━━━━━━━━━━━━━━━', 'log');
            addLog('🎉 初始化完成！', 'log');
            addLog(`targetMap size: ${debug.targetMap ? 'WeakMap' : 'N/A'}`, 'log');
            addLog(`parentMap size: ${debug.parentMap ? 'WeakMap' : 'N/A'}`, 'log');
        }, 100);
    </script>
</body>
</html>

