<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>细粒度更新测试</title>
    <script src="reactive-lit.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
        }
        .test-box {
            border: 2px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .item {
            background: #f0f0f0;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .item.flash {
            background: #ffeb3b;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔬 细粒度更新测试</h1>
    <p>观察哪些 DOM 节点被更新（会短暂闪黄色）</p>

    <div id="test-container"></div>
    <div class="log" id="log"></div>

    <script>
        const { html, createComponent, useState } = window.ReactiveLit;
        
        const logs = [];
        function log(message) {
            const time = new Date().toLocaleTimeString();
            logs.push(`[${time}] ${message}`);
            if (logs.length > 20) logs.shift();
            document.getElementById('log').innerHTML = logs.join('<br>');
        }

        // 监听 DOM 变化
        let updateCount = 0;
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            updateCount++;
                            log(`✨ DOM 节点被添加: ${node.tagName}`);
                            flashNode(node);
                        }
                    });
                    mutation.removedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            updateCount++;
                            log(`🗑️ DOM 节点被删除: ${node.tagName}`);
                        }
                    });
                } else if (mutation.type === 'characterData') {
                    updateCount++;
                    log(`📝 文本节点被更新: "${mutation.target.textContent.substring(0, 20)}..."`);
                    if (mutation.target.parentElement) {
                        flashNode(mutation.target.parentElement);
                    }
                }
            });
        });

        function flashNode(node) {
            node.classList.add('flash');
            setTimeout(() => node.classList.remove('flash'), 300);
        }

        createComponent('granular-test', () => {
            const items = useState([
                { id: 1, text: '项目 1', count: 0 },
                { id: 2, text: '项目 2', count: 0 },
                { id: 3, text: '项目 3', count: 0 }
            ]);

            const addItem = () => {
                const newId = items().length + 1;
                items([...items(), { id: newId, text: `项目 ${newId}`, count: 0 }]);
                log(`➕ 添加项目 ${newId}`);
            };

            const removeItem = () => {
                if (items().length > 0) {
                    const removed = items()[items().length - 1];
                    items(items().slice(0, -1));
                    log(`➖ 删除项目 ${removed.id}`);
                }
            };

            const updateItem = (index) => {
                const newItems = [...items()];
                newItems[index] = { ...newItems[index], count: newItems[index].count + 1 };
                items(newItems);
                log(`🔄 更新项目 ${newItems[index].id} 的计数`);
            };

            const updateFirstItemText = () => {
                const newItems = [...items()];
                newItems[0] = { ...newItems[0], text: `项目 1 (${Date.now() % 1000})` };
                items(newItems);
                log(`✏️ 修改第一个项目的文本`);
            };

            return html`
                <div class="test-box">
                    <h3>细粒度更新测试</h3>
                    <p>操作次数: ${updateCount}</p>
                    
                    <div>
                        <button onClick=${addItem}>➕ 添加项目</button>
                        <button onClick=${removeItem}>➖ 删除最后一项</button>
                        <button onClick=${updateFirstItemText}>✏️ 修改第一项文本</button>
                    </div>

                    <h4>列表 (${items().length} 项):</h4>
                    ${items().map((item, index) => html`
                        <div class="item">
                            <strong>${item.text}</strong> 
                            - 计数: ${item.count}
                            <button onClick=${() => updateItem(index)}>+1</button>
                        </div>
                    `)}

                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <h4>预期行为：</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>✅ 添加项目：只添加一个新节点</li>
                            <li>✅ 删除项目：只删除最后一个节点</li>
                            <li>✅ 更新计数：只更新对应项的文本</li>
                            <li>✅ 修改文本：只更新第一项的文本</li>
                        </ul>
                    </div>
                </div>
            `;
        });

        document.getElementById('test-container').innerHTML = '<granular-test></granular-test>';

        // 开始监听
        setTimeout(() => {
            const testEl = document.querySelector('granular-test');
            if (testEl && testEl.shadowRoot) {
                observer.observe(testEl.shadowRoot, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
                log('🎬 开始监听 DOM 变化...');
            }
        }, 100);
    </script>
</body>
</html>

