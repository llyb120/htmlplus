<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç»†ç²’åº¦æ›´æ–°æµ‹è¯•</title>
    <script src="reactive-lit.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
        }
        .test-box {
            border: 2px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .item {
            background: #f0f0f0;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .item.flash {
            background: #ffeb3b;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¬ ç»†ç²’åº¦æ›´æ–°æµ‹è¯•</h1>
    <p>è§‚å¯Ÿå“ªäº› DOM èŠ‚ç‚¹è¢«æ›´æ–°ï¼ˆä¼šçŸ­æš‚é—ªé»„è‰²ï¼‰</p>

    <div id="test-container"></div>
    <div class="log" id="log"></div>

    <script>
        const { html, createComponent, useState } = window.ReactiveLit;
        
        const logs = [];
        function log(message) {
            const time = new Date().toLocaleTimeString();
            logs.push(`[${time}] ${message}`);
            if (logs.length > 20) logs.shift();
            document.getElementById('log').innerHTML = logs.join('<br>');
        }

        // ç›‘å¬ DOM å˜åŒ–
        let updateCount = 0;
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            updateCount++;
                            log(`âœ¨ DOM èŠ‚ç‚¹è¢«æ·»åŠ : ${node.tagName}`);
                            flashNode(node);
                        }
                    });
                    mutation.removedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            updateCount++;
                            log(`ğŸ—‘ï¸ DOM èŠ‚ç‚¹è¢«åˆ é™¤: ${node.tagName}`);
                        }
                    });
                } else if (mutation.type === 'characterData') {
                    updateCount++;
                    log(`ğŸ“ æ–‡æœ¬èŠ‚ç‚¹è¢«æ›´æ–°: "${mutation.target.textContent.substring(0, 20)}..."`);
                    if (mutation.target.parentElement) {
                        flashNode(mutation.target.parentElement);
                    }
                }
            });
        });

        function flashNode(node) {
            node.classList.add('flash');
            setTimeout(() => node.classList.remove('flash'), 300);
        }

        createComponent('granular-test', () => {
            const items = useState([
                { id: 1, text: 'é¡¹ç›® 1', count: 0 },
                { id: 2, text: 'é¡¹ç›® 2', count: 0 },
                { id: 3, text: 'é¡¹ç›® 3', count: 0 }
            ]);

            const addItem = () => {
                const newId = items().length + 1;
                items([...items(), { id: newId, text: `é¡¹ç›® ${newId}`, count: 0 }]);
                log(`â• æ·»åŠ é¡¹ç›® ${newId}`);
            };

            const removeItem = () => {
                if (items().length > 0) {
                    const removed = items()[items().length - 1];
                    items(items().slice(0, -1));
                    log(`â– åˆ é™¤é¡¹ç›® ${removed.id}`);
                }
            };

            const updateItem = (index) => {
                const newItems = [...items()];
                newItems[index] = { ...newItems[index], count: newItems[index].count + 1 };
                items(newItems);
                log(`ğŸ”„ æ›´æ–°é¡¹ç›® ${newItems[index].id} çš„è®¡æ•°`);
            };

            const updateFirstItemText = () => {
                const newItems = [...items()];
                newItems[0] = { ...newItems[0], text: `é¡¹ç›® 1 (${Date.now() % 1000})` };
                items(newItems);
                log(`âœï¸ ä¿®æ”¹ç¬¬ä¸€ä¸ªé¡¹ç›®çš„æ–‡æœ¬`);
            };

            return html`
                <div class="test-box">
                    <h3>ç»†ç²’åº¦æ›´æ–°æµ‹è¯•</h3>
                    <p>æ“ä½œæ¬¡æ•°: ${updateCount}</p>
                    
                    <div>
                        <button onClick=${addItem}>â• æ·»åŠ é¡¹ç›®</button>
                        <button onClick=${removeItem}>â– åˆ é™¤æœ€åä¸€é¡¹</button>
                        <button onClick=${updateFirstItemText}>âœï¸ ä¿®æ”¹ç¬¬ä¸€é¡¹æ–‡æœ¬</button>
                    </div>

                    <h4>åˆ—è¡¨ (${items().length} é¡¹):</h4>
                    ${items().map((item, index) => html`
                        <div class="item">
                            <strong>${item.text}</strong> 
                            - è®¡æ•°: ${item.count}
                            <button onClick=${() => updateItem(index)}>+1</button>
                        </div>
                    `)}

                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <h4>é¢„æœŸè¡Œä¸ºï¼š</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>âœ… æ·»åŠ é¡¹ç›®ï¼šåªæ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹</li>
                            <li>âœ… åˆ é™¤é¡¹ç›®ï¼šåªåˆ é™¤æœ€åä¸€ä¸ªèŠ‚ç‚¹</li>
                            <li>âœ… æ›´æ–°è®¡æ•°ï¼šåªæ›´æ–°å¯¹åº”é¡¹çš„æ–‡æœ¬</li>
                            <li>âœ… ä¿®æ”¹æ–‡æœ¬ï¼šåªæ›´æ–°ç¬¬ä¸€é¡¹çš„æ–‡æœ¬</li>
                        </ul>
                    </div>
                </div>
            `;
        });

        document.getElementById('test-container').innerHTML = '<granular-test></granular-test>';

        // å¼€å§‹ç›‘å¬
        setTimeout(() => {
            const testEl = document.querySelector('granular-test');
            if (testEl && testEl.shadowRoot) {
                observer.observe(testEl.shadowRoot, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
                log('ğŸ¬ å¼€å§‹ç›‘å¬ DOM å˜åŒ–...');
            }
        }, 100);
    </script>
</body>
</html>

