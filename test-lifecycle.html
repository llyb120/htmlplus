<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>生命周期测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
        }
        .box {
            border: 2px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background: #f9f9ff;
        }
        .log {
            background: #1e1e1e;
            color: #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log div {
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #5568d3;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 生命周期钩子测试</h1>
        <p style="text-align: center; color: #666;">
            测试 onMounted 和 onUnmounted 生命周期
        </p>

        <div class="box">
            <h3>📋 日志</h3>
            <div class="log" id="logs"></div>
        </div>

        <div class="box">
            <h3>🎮 控制面板</h3>
            <button onclick="mountComponent()">➕ 挂载组件</button>
            <button onclick="unmountComponent()" class="danger">➖ 卸载组件</button>
            <button onclick="clearLogs()">🧹 清空日志</button>
        </div>

        <div id="app"></div>
    </div>

    <script src="reactive-lit.js"></script>
    <script>
        const { html, createComponent, useState, onMounted, onUnmounted } = window.ReactiveLit;

        const logs = [];
        function log(msg, color = '#4caf50') {
            const time = new Date().toLocaleTimeString();
            logs.push(`<div style="color: ${color}">[${time}] ${msg}</div>`);
            document.getElementById('logs').innerHTML = logs.join('');
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function clearLogs() {
            logs.length = 0;
            document.getElementById('logs').innerHTML = '';
        }

        // 创建测试组件
        createComponent('lifecycle-test', () => {
            log('🎬 Setup 函数执行（只执行一次）', '#ff9800');
            
            const count = useState(0);
            const setupTime = new Date().toLocaleTimeString();
            
            // 定时器引用
            let timer = null;
            
            // onMounted 钩子
            onMounted(() => {
                log('✅ onMounted: 组件已挂载到 DOM', '#4caf50');
                
                // 启动定时器
                timer = setInterval(() => {
                    count(count() + 1);
                    log(`⏱️  定时器触发，count = ${count()}`, '#2196f3');
                }, 2000);
                
                log(`⏰ 定时器已启动 (ID: ${timer})`, '#2196f3');
            });
            
            // onUnmounted 钩子
            onUnmounted(() => {
                log('❌ onUnmounted: 组件即将卸载', '#f44336');
                
                // 清理定时器
                if (timer) {
                    clearInterval(timer);
                    log(`🛑 定时器已清理 (ID: ${timer})`, '#f44336');
                }
            });
            
            log('📝 Setup 完成，返回渲染函数', '#ff9800');
            
            // 返回渲染函数
            return () => {
                log('🎨 渲染函数执行', '#9c27b0');
                
                return html`
                    <div class="box" style="background: #e3f2fd; border-color: #2196f3;">
                        <h3 style="color: #2196f3;">🧪 测试组件</h3>
                        <div style="padding: 15px; background: white; border-radius: 5px;">
                            <p><strong>Setup 时间:</strong> ${setupTime}</p>
                            <p><strong>当前计数:</strong> <span style="font-size: 24px; color: #667eea; font-weight: bold;">${count()}</span></p>
                            <p style="color: #666; font-size: 14px;">
                                计数器每 2 秒自动增加一次<br>
                                卸载组件时会清理定时器
                            </p>
                            <button onClick=${() => count(count() + 1)}>
                                ➕ 手动增加
                            </button>
                            <button onClick=${() => count(0)} style="background: #ff9800;">
                                🔄 重置
                            </button>
                        </div>
                    </div>
                `;
            };
        });

        let componentMounted = false;

        function mountComponent() {
            if (componentMounted) {
                log('⚠️  组件已经挂载', '#ff9800');
                return;
            }
            
            log('━━━━━━━━━━━━━━━━━━━━━━', '#666');
            log('📌 开始挂载组件...', '#ff9800');
            
            document.getElementById('app').innerHTML = '<lifecycle-test></lifecycle-test>';
            componentMounted = true;
            
            setTimeout(() => {
                log('━━━━━━━━━━━━━━━━━━━━━━', '#666');
            }, 100);
        }

        function unmountComponent() {
            if (!componentMounted) {
                log('⚠️  没有组件需要卸载', '#ff9800');
                return;
            }
            
            log('━━━━━━━━━━━━━━━━━━━━━━', '#666');
            log('🗑️  开始卸载组件...', '#ff9800');
            
            document.getElementById('app').innerHTML = '';
            componentMounted = false;
            
            setTimeout(() => {
                log('━━━━━━━━━━━━━━━━━━━━━━', '#666');
            }, 100);
        }

        // 初始化
        log('🎉 页面加载完成', '#4caf50');
        log('💡 点击"挂载组件"按钮开始测试', '#666');
        log('━━━━━━━━━━━━━━━━━━━━━━', '#666');
    </script>
</body>
</html>

