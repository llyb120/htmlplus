<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>详细调试</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .log {
            background: #2d2d2d;
            padding: 5px 10px;
            margin: 2px 0;
            border-left: 3px solid #007acc;
            font-size: 12px;
        }
        .error { border-left-color: #f44336; color: #f44336; }
        .success { border-left-color: #4caf50; color: #4caf50; }
        .warning { border-left-color: #ff9800; color: #ff9800; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        #display {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #4caf50;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>🔍 详细调试</h1>
    <div id="display">等待初始化...</div>
    <div id="logs" style="max-height: 400px; overflow-y: auto;"></div>

    <script>
        const logs = [];
        function log(message, type = 'log') {
            const time = new Date().toLocaleTimeString();
            logs.push({ time, message, type });
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = logs.map(l => 
                `<div class="log ${l.type}">[${l.time}] ${l.message}</div>`
            ).join('');
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // 先记录原始函数
        log('📦 开始加载 reactive-lit.js...', 'warning');
    </script>
    
    <script src="reactive-lit.js"></script>
    
    <script>
        log('✅ reactive-lit.js 加载完成', 'success');
        
        const { html, createComponent, useState } = window.ReactiveLit;
        log('✅ 解构 API 完成', 'success');

        // 拦截 track 和 trigger 来查看调用
        let trackCalls = [];
        let triggerCalls = [];
        let renderCount = 0;

        createComponent('debug-component', () => {
            renderCount++;
            log(`🎬 组件渲染 #${renderCount}`, 'warning');
            
            const arr = useState([1, 2, 3]);
            log(`  ├─ arr 初始化/读取: [${arr()}]`);
            
            const obj = useState({ a: 1 });
            log(`  └─ obj 初始化/读取: ${JSON.stringify(obj())}`);

            const handlePush = () => {
                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'warning');
                log('🔴 点击 push 按钮', 'error');
                log(`  当前 arr: [${arr()}]`);
                
                try {
                    log('  调用 arr().push(999)...', 'warning');
                    const result = arr().push(999);
                    log(`  ✅ push 返回: ${result}`, 'success');
                    log(`  现在 arr: [${arr()}]`);
                } catch (e) {
                    log(`  ❌ 错误: ${e.message}`, 'error');
                }
            };

            const handleObjIncrement = () => {
                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'warning');
                log('🔵 点击 obj.a++ 按钮', 'error');
                log(`  当前 obj.a: ${obj().a}`);
                
                try {
                    log('  调用 obj().a++...', 'warning');
                    obj().a++;
                    log(`  ✅ 自增完成`, 'success');
                    log(`  现在 obj.a: ${obj().a}`);
                } catch (e) {
                    log(`  ❌ 错误: ${e.message}`, 'error');
                }
            };

            const handleReassign = () => {
                log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'warning');
                log('🟢 点击重新赋值按钮', 'error');
                
                try {
                    log('  调用 arr([...arr(), 888])...', 'warning');
                    arr([...arr(), 888]);
                    log(`  ✅ 重新赋值完成`, 'success');
                    log(`  现在 arr: [${arr()}]`);
                } catch (e) {
                    log(`  ❌ 错误: ${e.message}`, 'error');
                }
            };

            const template = html`
                <div style="background: #2d2d2d; padding: 20px; border-radius: 8px;">
                    <h2 style="color: #4caf50;">渲染 #${renderCount}</h2>
                    <div style="margin: 15px 0; padding: 15px; background: #1e1e1e; border-radius: 5px;">
                        <div style="color: #ff9800; font-size: 20px;">
                            数组: [${arr().join(', ')}]
                        </div>
                        <div style="color: #2196f3; font-size: 20px; margin-top: 10px;">
                            对象: a = ${obj().a}
                        </div>
                    </div>
                    
                    <button onClick=${handlePush}>
                        📝 arr().push(999)
                    </button>
                    
                    <button onClick=${handleObjIncrement}>
                        ➕ obj().a++
                    </button>
                    
                    <button onClick=${handleReassign}>
                        🔄 arr([...arr(), 888])
                    </button>
                </div>
            `;
            
            log(`  ✅ 模板创建完成`, 'success');
            return template;
        });

        log('🎯 准备挂载组件...', 'warning');
        const displayDiv = document.getElementById('display');
        displayDiv.innerHTML = '<debug-component></debug-component>';
        
        setTimeout(() => {
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'success');
            log('🎉 初始化完成！请点击按钮测试', 'success');
            log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', 'success');
        }, 100);
    </script>
</body>
</html>

